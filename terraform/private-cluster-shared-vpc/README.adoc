- This variation deploys a private cluster with a shared vpc
- This example is currently leveraging project level iam binding for the networkUser permission.

[source,bash]
----
terraform apply -auto-approve
----


### Workaround - when wanting to use subnet iam binding

- etags as input not yet supported in terraform? - https://github.com/terraform-providers/terraform-provider-google/issues/2108
- If attempting to use the subnet iam binding, below would be the workaround.  

[source,bash]
----
terraform apply -auto-approve -target=google_compute_subnetwork.subnet0

HOST_PROJECT=...
SERVICE_PROJECT=...

# Get the ETAG
ETAG=`gcloud beta compute networks subnets get-iam-policy gke-subnet \
    --project $HOST_PROJECT \
    --region us-west1 \
    | grep etag | awk '{print $2}'`

SERVICE_PROJECT_NUMBER=`gcloud projects describe $HOST_PROJECT --format 'value(projectNumber)'`

cat <<EOF > binding.yaml 
- members:
  - serviceAccount:$SERVICE_PROJECT_NUMBER@cloudservices.gserviceaccount.com
  - serviceAccount:service-$SERVICE_PROJECT_NUMBER@container-engine-robot.iam.gserviceaccount.com
  role: roles/compute.networkUser
etag: $ETAG
EOF

gcloud beta compute networks subnets set-iam-policy gke-subnet \
    binding.yaml \
    --project $HOST_PROJECT \
    --region us-west1

terraform apply -auto-approve -target=google_container_node_pool.nodepool0
----